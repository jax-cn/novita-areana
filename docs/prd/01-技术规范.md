# Novita Arena - 技术规范

**版本**: 1.1
**最后更新**: 2025-01-09
**产品名称**: Novita Arena

---

## 目录

1. [技术架构](#1-技术架构)
2. [数据库设计](#2-数据库设计)
3. [API 接口概览](#3-api-接口概览)
4. [开发环境配置](#4-开发环境配置)

---

## 1. 技术架构

### 1.1 整体架构

本产品参考 **E2B Fragments** 的设计思路，采用前后端统一的 Node.js 技术栈。

```
┌─────────────────────────────────────────────────────────────┐
│                         前端层                               │
├─────────────────────────────────────────────────────────────┤
│  Next.js 15+  │  React 19+  │  Tailwind CSS  │  shadcn/ui  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      API 路由层                              │
├─────────────────────────────────────────────────────────────┤
│  Next.js API Routes  │  认证中间件  │  速率限制 │  文件上传    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      业务逻辑层                              │
├─────────────────────────────────────────────────────────────┤
│  沙盒管理  │  代码生成  │  账户/余额            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    外部服务集成                              │
├─────────────────────────────────────────────────────────────┤
│  Novita LLM  │  Novita Sandbox  │  Novita Auth ｜ 文件存储 │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层                              │
├─────────────────────────────────────────────────────────────┤
│  Supabase (PostgreSQL)  │  AWS S3  │  CDN                   │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术选型

#### 前端技术栈

| 技术 | 版本/说明 | 用途 |
|------|----------|------|
| **Next.js** | 15+ | 全栈框架，前后端统一 |
| **React** | 19+ | UI 框架 |
| **TypeScript** | 5.x | 类型安全 |
| **Tailwind CSS** | 4.x | 样式系统 |
| **shadcn/ui** | Latest | UI 组件库 |
| **Lucide Icons** |lucide-react | 图标库 |

#### 后端技术栈

| 技术 | 说明 | 用途 |
|------|------|------|
| **Next.js API Routes** | 服务端 API | 业务逻辑处理 |
| **Novita LLM** | 外部服务 | AI 代码生成 |
| **Novita Sandbox** | 外部服务 | 代码执行与构建 |
| **Novita Auth** | 外部服务 | 统一认证 |

#### 数据与存储

| 技术 | 说明 | 用途 |
|------|------|------|
| **Supabase** | PostgreSQL | 主数据库 |
| **AWS S3** | 对象存储 | 视频、代码包存储 |

### 1.3 核心设计理念

#### 参考 E2B Fragments

E2B Fragments 的核心特点：
1. **代码片段沙箱执行**: 在隔离环境中安全执行用户代码
2. **实时预览**: 即时反馈代码执行结果
3. **模板系统**: 预定义代码模板加速开发
4. **版本控制**: 每个片段都有版本历史

我们的借鉴：
- **沙箱隔离**: 使用 Novita Sandbox 隔离执行生成的代码
- **实时预览**: iframe 预览 + WebSocket 实时更新
- **代码模板**: 预设技术栈模板（Vite + Three.js 等）
- **版本管理**: 每次生成保存完整快照

### 1.4 生成流程

#### 1.4.1 PK 生成流程

```
1. 用户在首页选择灵感和效果库（或直接输入 Prompt）
   ↓
2. 前端调用 Next.js API (POST /api/generate)
   Body: {
     prompt: "创建一个 3D 时钟...",
     modelA: "Claude 3.5 Sonnet",
     modelB: "GPT-4o",
     effect: "3D效果 > 粒子系统"
   }
   ↓
3. API 验证用户认证与额度
   ↓
4. 并行调用 Novita LLM 服务生成代码（双模型）
   - 模型 A: 代码生成
   - 模型 B: 代码生成
   ↓
5. 启动两个 Novita Sandbox 实例
   ↓
6. 获取 Novita Sandbox Host URLs
   ↓
7. 返回预览 URLs 给前端
   ↓
8. 前端 iframe 加载双预览（50/50 分屏）
   ↓
9. 用户与两侧应用交互，对比效果
```

#### 1.4.2 录制与分享流程

```
1. 用户点击录制按钮
   ↓
2. 前端开始录制（MediaRecorder API）
   - 录制范围: 整个标签页
   - 只读提示词显示在顶部，作为附加信息
   ↓
3. 用户与预览区交互
   ↓
4. 用户点击"完成"按钮
   ↓
5. 前端停止录制，生成视频 Blob
   ↓
6. 前端调用 Next.js API (POST /api/generate-name)
   Body: { prompt: "创建一个 3D 时钟..." }
   ↓
7. 后端调用 Novita LLM 服务生成应用名称
   System: "你是一个应用命名专家。根据用户提示词，生成一个简洁、吸引人的应用名称（不超过 15 字）。"
   User: "{user_prompt}"
   ↓
8. 返回生成的名称
   Response: { name: "3D 时钟 - 粒子特效版" }
   ↓
9. 前端打开分享弹窗，预填充生成的名称
   ↓
10. 用户编辑名称（可选）或直接使用
   ↓
11. 用户选择分享到社交平台或社区画廊
   ↓
12. 上传视频到 AWS S3
   ↓
13. 保存应用信息到 Supabase
```

---

## 2. 数据库设计

> **状态**: 待实现

### 2.1 数据表设计

#### apps (应用表)

```sql
CREATE TABLE apps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),

  -- 应用信息
  name VARCHAR(255) NOT NULL,
  description TEXT,
  prompt TEXT NOT NULL,

  -- 生成信息
  model_a VARCHAR(100) NOT NULL,
  model_b VARCHAR(100) NOT NULL,
  model_a_version VARCHAR(50),
  model_b_version VARCHAR(50),

  -- 代码与构建
  code_a_url TEXT,
  code_b_url TEXT,
  deploy_a_url TEXT NOT NULL,
  deploy_b_url TEXT NOT NULL,
  build_status VARCHAR(50),

  -- 媒体资源
  preview_a_thumbnail_url TEXT,
  preview_b_thumbnail_url TEXT,
  preview_video_url TEXT,

  -- 互动数据
  fork_count INTEGER DEFAULT 0,
  like_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,

  -- 元数据
  is_featured BOOLEAN DEFAULT FALSE,
  is_public BOOLEAN DEFAULT TRUE,
  parent_app_id UUID REFERENCES apps(id),

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_apps_user_id ON apps(user_id);
CREATE INDEX idx_apps_is_public ON apps(is_public);
CREATE INDEX idx_apps_created_at ON apps(created_at DESC);
CREATE INDEX idx_apps_like_count ON apps(like_count DESC);
```

#### users (用户表)

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Novita Auth 关联
  novita_user_id VARCHAR(255) UNIQUE NOT NULL,

  -- 用户信息
  email VARCHAR(255),
  username VARCHAR(100),
  avatar_url TEXT,

  -- 额度信息
  credit_balance INTEGER DEFAULT 100,
  credit_used INTEGER DEFAULT 0,

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  last_login_at TIMESTAMP
);

-- 索引
CREATE INDEX idx_users_novita_user_id ON users(novita_user_id);
CREATE INDEX idx_users_email ON users(email);
```

#### battle_runs (对战运行记录)

```sql
CREATE TABLE battle_runs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  app_id UUID REFERENCES apps(id),
  user_id UUID REFERENCES users(id),

  -- 模型配置
  model_a VARCHAR(100) NOT NULL,
  model_b VARCHAR(100) NOT NULL,

  -- 性能指标
  model_a_tokens INTEGER,
  model_b_tokens INTEGER,
  model_a_time_ms INTEGER,
  model_b_time_ms INTEGER,

  -- 用户投票
  winner_model VARCHAR(10), -- 'A' or 'B' or 'TIE'

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_battle_runs_app_id ON battle_runs(app_id);
CREATE INDEX idx_battle_runs_user_id ON battle_runs(user_id);
```

#### likes (点赞表)

```sql
CREATE TABLE likes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  app_id UUID REFERENCES apps(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW(),

  -- 唯一约束
  UNIQUE(app_id, user_id)
);

-- 索引
CREATE INDEX idx_likes_app_id ON likes(app_id);
CREATE INDEX idx_likes_user_id ON likes(user_id);
```

---

## 3. API 接口概览

> **状态**: 待实现

### 3.1 认证接口

#### POST /api/auth/login
**描述**: 用户登录

**请求**:
```json
{
  "token": "novita_auth_token"
}
```

**响应**:
```json
{
  "success": true,
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "username": "username",
    "credit_balance": 100
  },
  "token": "session_token"
}
```

#### GET /api/auth/me
**描述**: 获取当前用户信息

**响应**:
```json
{
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "username": "username",
    "credit_balance": 95,
    "credit_used": 5
  }
}
```

### 3.2 生成接口

#### POST /api/generate
**描述**: 生成 PK 应用

**请求**:
```json
{
  "prompt": "创建一个 3D 时钟...",
  "modelA": "Claude 3.5 Sonnet",
  "modelB": "GPT-4o",
  "effect": "3D效果 > 粒子系统"
}
```

**响应**:
```json
{
  "success": true,
  "app": {
    "id": "uuid",
    "deploy_a_url": "https://sandbox-1.novita.ai/...",
    "deploy_b_url": "https://sandbox-2.novita.ai/...",
    "build_status": "building"
  }
}
```

#### POST /api/generate-name
**描述**: 生成应用名称

**请求**:
```json
{
  "prompt": "创建一个 3D 时钟..."
}
```

**响应**:
```json
{
  "name": "3D 时钟 - 粒子特效版"
}
```

### 3.3 对战接口

#### GET /api/battle/:id
**描述**: 获取对战详情

**响应**:
```json
{
  "id": "uuid",
  "app": {
    "name": "3D 时钟",
    "prompt": "创建一个 3D 时钟..."
  },
  "models": {
    "modelA": "Claude 3.5 Sonnet",
    "modelB": "GPT-4o"
  },
  "stats": {
    "model_a_tokens": 2405,
    "model_b_tokens": 2110,
    "model_a_time_ms": 8200,
    "model_b_time_ms": 6800
  }
}
```

### 3.4 媒体接口

#### POST /api/media/upload
**描述**: 上传视频

**请求**: `multipart/form-data`
```
video: <video file>
app_id: "uuid"
```

**响应**:
```json
{
  "success": true,
  "url": "https://s3.amazonaws.com/novita-arena/videos/..."
}
```

### 3.5 应用接口

#### GET /api/apps
**描述**: 获取应用列表

**查询参数**:
- `category`: hot | latest
- `page`: 页码
- `limit`: 每页数量

**响应**:
```json
{
  "apps": [
    {
      "id": "uuid",
      "name": "3D 时钟 - 粒子特效版",
      "description": "一个基于 Three.js 的 3D 时钟...",
      "thumbnail_a_url": "https://...",
      "thumbnail_b_url": "https://...",
      "model_a": "Claude 3.5 Sonnet",
      "model_b": "GPT-4o",
      "like_count": 128,
      "view_count": 1520,
      "created_at": "2025-01-09T10:30:00Z"
    }
  ],
  "total": 100,
  "page": 1,
  "limit": 20
}
```

#### GET /api/apps/:id
**描述**: 获取应用详情

**响应**:
```json
{
  "id": "uuid",
  "name": "3D 时钟 - 粒子特效版",
  "description": "一个基于 Three.js 的 3D 时钟...",
  "prompt": "创建一个 3D 时钟，包含粒子特效...",
  "model_a": "Claude 3.5 Sonnet",
  "model_b": "GPT-4o",
  "deploy_a_url": "https://sandbox-1.novita.ai/...",
  "deploy_b_url": "https://sandbox-2.novita.ai/...",
  "preview_video_url": "https://s3.amazonaws.com/...",
  "like_count": 128,
  "fork_count": 45,
  "view_count": 1520,
  "created_at": "2025-01-09T10:30:00Z"
}
```

#### POST /api/apps/:id/like
**描述**: 点赞应用

**响应**:
```json
{
  "success": true,
  "like_count": 129
}
```

#### POST /api/apps/:id/fork
**描述**: Fork 应用

**请求**:
```json
{
  "prompt": "修改后的提示词..."
}
```

**响应**:
```json
{
  "success": true,
  "app_id": "new_uuid"
}
```

---

## 4. 开发环境配置

### 4.1 环境变量

#### Novita 服务
```bash
# Novita API 配置
NOVITA_API_KEY=your_api_key
NOVITA_LLM_ENDPOINT=https://api.novita.ai/v1
NOVITA_SANDBOX_ENDPOINT=https://sandbox.novita.ai
NOVITA_AUTH_ENDPOINT=https://auth.novita.ai
```

#### Supabase
```bash
# Supabase 配置
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

#### AWS S3
```bash
# AWS S3 配置
AWS_S3_BUCKET=novita-arena
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_CDN_DISTRIBUTION_ID=your_cloudfront_id
```

#### 应用配置
```bash
# 应用配置
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_API_URL=http://localhost:3000/api

# 功能开关
ENABLE_BATTLE_MODE=true
ENABLE_RECORDING=true
ENABLE_SOCIAL_SHARE=true
```

### 4.2 项目结构

```
novita-arena/
├── app/                      # Next.js App Router
│   ├── (auth)/              # 认证相关路由
│   │   └── login/
│   ├── gallery/             # 画廊页面
│   │   └── page.tsx
│   ├── playground/          # 创作页面
│   │   └── page.tsx
│   ├── api/                 # API 路由
│   │   ├── auth/            # 认证接口
│   │   ├── generate/        # 生成接口
│   │   ├── battle/          # 对战接口
│   │   ├── apps/            # 应用管理
│   │   └── media/           # 媒体上传
│   ├── layout.tsx
│   └── page.tsx
├── components/
│   ├── ui/                  # shadcn/ui 组件
│   ├── app/                 # 应用特定组件
│   │   ├── app-card.tsx
│   │   ├── model-badge.tsx
│   │   ├── recording-indicator.tsx
│   │   └── share-modal.tsx
│   └── layout/              # 布局组件
│       ├── header.tsx
│       └── footer.tsx
├── lib/
│   ├── novita/              # Novita 服务集成
│   │   ├── llm.ts
│   │   ├── sandbox.ts
│   │   └── auth.ts
│   ├── supabase/            # Supabase 客户端
│   │   ├── client.ts
│   │   └── server.ts
│   ├── s3.ts                # S3 客户端
│   └── utils.ts             # 工具函数
├── types/                   # TypeScript 类型
│   └── index.ts
├── hooks/                   # React Hooks
│   ├── useAuth.ts
│   ├── useGeneration.ts
│   └── useRecording.ts
├── public/                  # 静态资源
│   ├── icons/
│   └── images/
├── docs/                    # 文档
│   └── prd/
├── .env.local
├── next.config.ts
├── package.json
├── tsconfig.json
└── tailwind.config.ts
```

### 4.3 服务配置

#### Novita LLM 服务
```typescript
// lib/novita/llm.ts
export const llmConfig = {
  endpoint: process.env.NOVITA_LLM_ENDPOINT,
  apiKey: process.env.NOVITA_API_KEY,
  defaultModel: "claude-3-5-sonnet",
  maxTokens: 4000,
  temperature: 0.7,
};
```

#### Novita Sandbox 服务
```typescript
// lib/novita/sandbox.ts
export const sandboxConfig = {
  endpoint: process.env.NOVITA_SANDBOX_ENDPOINT,
  apiKey: process.env.NOVITA_API_KEY,
  timeout: 120000, // 2 分钟
  maxInstances: 2,
};
```

#### Supabase 客户端
```typescript
// lib/supabase/client.ts
export const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
);
```

#### AWS S3 客户端
```typescript
// lib/s3.ts
export const s3Config = {
  bucket: process.env.AWS_S3_BUCKET,
  region: process.env.AWS_REGION,
  accessKeyId: process.env.AWS_ACCESS_KEY_ID,
  secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY,
};
```

---

## 相关文档

- **产品概览**: 详见 [00-产品概览.md](./00-产品概览.md)
- **页面设计**: 详见 [02-页面规范.md](./02-页面规范.md)
- **运营设计**: 详见 [03-运营与设计.md](./03-运营与设计.md)
