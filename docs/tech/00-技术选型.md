# Novita Arena - 技术选型

**版本**: 1.2
**最后更新**: 2025-01-17
**状态**: 设计阶段

---

## 目录

1. [架构原则](#1-架构原则)
2. [前端技术栈](#2-前端技术栈)
3. [后端技术栈](#3-后端技术栈)
4. [外部服务集成](#4-外部服务集成)
5. [核心设计决策](#5-核心设计决策)

---

## 1. 架构原则

### 1.1 简化优先
- **无 Redis**：使用 Supabase PostgreSQL 存储所有数据
- **前后端分离**：前端负责 Sandbox API 调用和流式响应，后端只负责认证、数据记录和外部服务协调
- **避免过度设计**：不考虑未来扩展，一切为了简单和快

### 1.2 职责划分
- **后端只负责**：
  - 用户认证（对接 Novita Auth）
  - IP 额度控制
  - 创建/查询 Sandbox 实例
  - 数据库记录
  - 触发/轮询 Vercel 部署

- **前端负责**：
  - Sandbox API 调用（生成请求 + SSE 流）
  - 录屏和上传 Cloudflare Stream
  - 状态管理
  - UI 交互

---

## 2. 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Next.js** | 15+ | 全栈框架，App Router |
| **React** | 19+ | UI 框架 |
| **TypeScript** | 5.x | 类型安全 |
| **Tailwind CSS** | 4.x | 样式系统 |
| **shadcn/ui** | Latest | UI 组件库 |
| **Lucide Icons** | lucide-react | 图标库 |
| **Zustand** | Latest | 状态管理 |
| **MediaRecorder API** | 浏览器原生 | 录屏功能 |
| **html2canvas** | Latest | 截图生成 Poster |
| **EventSource** | 浏览器原生 | SSE 流接收 |

---

## 3. 后端技术栈

| 技术 | 说明 | 用途 |
|------|------|------|
| **Next.js API Routes** | 服务端 API | 业务逻辑处理 |
| **Supabase** | PostgreSQL | 主数据库 |
| **Novita Sandbox** | 外部服务 | 代码执行与构建 |
| **Novita Auth** | 外部服务 | 统一认证 |

---

## 4. 外部服务集成

### 4.1 Novita 服务
- **Novita LLM**：AI 代码生成
- **Novita Sandbox**：代码执行与预览
  - 内部 Coding Agent 调用 LLM 生成代码
  - 提供 `/generate` 接口接收生成请求
  - 提供 `/stream/{generation_id}` SSE 接口返回生成进度
  - 提供 `/deploy` 接口部署到 Vercel
  - 环境变量传入：`VERCEL_TOKEN`
- **Novita Auth**：统一认证
  - 登录后设置 Cookie
  - `/user/info` 返回用户信息（uuid, email, username 等）

### 4.2 Cloudflare Stream
- **Direct Creator Uploads**：生成一次性上传 URL
  - 返回 `uploadURL` + `videoUid`
  - 预览 URL 拼接：`https://customer-{CODE}.cloudflarestream.com/{videoUid}/watch`

### 4.3 Vercel
- **管理员账号托管**：用户分享的 app 部署到统一的 Vercel 账号
- **Sandbox 内部部署**：通过 `vercel deploy --prod --yes` 命令
- **双模型部署**：模型 A 和 B 都需要独立部署

---

## 5. 核心设计决策

### 5.1 后端角色变化
**原始设计**：
```
后端调用 LLM → 生成代码 → 传给 Sandbox → 部署
```

**新设计**：
```
后端创建 Sandbox → 返回 Sandbox Host URLs
  ↓
前端直接调用 Sandbox API → Sandbox 内部调用 LLM → 流式返回
```

### 5.2 API Key 管理
- 支持保存任意类型 Key：`novita_key` | `claude_key` | `other`
- 前端快捷调用 Novita Key 生成 API（借助登录时的 Token）
- 后端不生成 Key，只负责存储

### 5.3 Sandbox URL 返回
- 返回完整数据结构：
  ```json
  {
    "id": "sandbox-xxx",
    "hostUrl": "https://port-id.sandbox.novita.ai",
    "previewPort": 3000,
    "servicePort": 8000
  }
  ```
- 数据表存储 Sandbox ID，而非 Host URL

### 5.4 Sandbox Session 防重入
- POST `{sandbox_url}/generate` 需要检查是否有生成中的 Session
- 如果有，返回错误："已有生成中的 Session，请先完成或停止"
- 前端显示友好提示

### 5.5 Vercel Token 传递
- Sandbox 启动时通过环境变量传入：`VERCEL_TOKEN=xxx`

### 5.6 Cloudflare Stream 上传
- 使用 **Direct Creator Uploads** 方案
- 后端生成上传 URL 时已知道预览 URL
- 前端上传完成后，直接使用预览 URL

### 5.7 匿名用户限制
- IP 记录用 PostgreSQL，无 Redis
- 一个 IP 只能创建一次项目
- 匿名用户禁用点赞、fork 等功能

---

## 相关文档

- **使用流程**: 详见 [01-使用流程.md](./01-使用流程.md)
- **接口设计**: 详见 [02-接口设计.md](./02-接口设计.md)
- **数据库设计**: 详见 [03-数据库设计.md](./03-数据库设计.md)
