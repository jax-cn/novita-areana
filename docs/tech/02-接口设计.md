# Novita Arena - 接口设计

**版本**: 1.2
**最后更新**: 2025-01-17
**状态**: 设计阶段

---

## 目录

1. [认证接口](#1-认证接口)
2. [App 生成接口](#2-app-生成接口)
3. [媒体接口](#3-媒体接口)
4. [分享接口](#4-分享接口)
5. [画廊接口](#5-画廊接口)
6. [Sandbox 接口规范](#6-sandbox-接口规范)

---

## 1. 认证接口

### 1.1 GET /api/auth
**描述**：Novita Auth 回调入口

**请求**：
```typescript
// Novita 后端 Set-Cookie 后 307 跳转到此接口
// 无需额外参数
```

**响应**：
```typescript
{
  success: true,
  user: {
    id: "uuid",
    novitaUserId: "275",
    novitaUuid: "4d0b42a8-8c2e-4e28-b6b1-1920a78fc81c",
    email: "user@example.com",
    username: "username",
    firstName: "Jax",
    lastName: "Williams",
    tier: "T4",
    hasApiKey: false  // 是否已填 API Key
  },
  redirectUrl: string  // 跳转到最开始设置的 redirect_url
}
```

### 1.2 POST /api/auth/save-api-key
**描述**：保存 API Key

**请求**：
```typescript
{
  keyType: "novita" | "claude" | "other",
  apiKey: string
}
```

**响应**：
```typescript
{
  success: true,
  message: "API Key 已保存"
}
```

**错误**：
```typescript
{
  success: false,
  error: "API Key 验证失败"
}
```

---

## 2. App 生成接口

### 2.1 POST /api/apps/create
**描述**：创建 App（2 个 Sandbox 实例）

**请求**：
```typescript
{
  prompt: string,
  modelA: string,  // 例如：claude-3-5-sonnet
  modelB: string   // 例如：gpt-4o
}
```

**响应**：
```typescript
{
  success: true,
  appId: string,
  sandboxA: {
    id: string,              // sandbox ID
    hostUrl: string,         // https://port-id.sandbox.novita.ai
    previewPort: 3000,
    servicePort: 8000
  },
  sandboxB: {
    id: string,
    hostUrl: string,
    previewPort: 3000,
    servicePort: 8000
  }
}
```

**错误**：
```typescript
// 匿名用户，IP 已用完免费额度
{
  success: false,
  error: "免费额度已用完，请登录"
}

// 已登录用户，未填 API Key
{
  success: false,
  error: "请先填写 API Key"
}
```

### 2.2 POST /api/apps/:id/stop
**描述**：停止生成（销毁 Sandbox 实例）

**请求**：
```typescript
// 无需请求体
```

**响应**：
```typescript
{
  success: true,
  message: "已停止生成"
}
```

### 2.3 POST /api/apps/:id/update-video-url
**描述**：更新录屏视频 URL

**请求**：
```typescript
{
  previewVideoUrl: string  // Cloudflare Stream 预览 URL
}
```

**响应**：
```typescript
{
  success: true
}
```

---

## 3. 媒体接口

### 3.1 POST /api/media/upload-url
**描述**：生成 Cloudflare Stream 上传 URL

**请求**：
```typescript
{
  appId: string  // 可选，用于关联 app
}
```

**响应**：
```typescript
{
  success: true,
  uploadUrl: string,    // https://upload.cloudflarestream.com/...
  videoUid: string,     // 6b9e68b07dfee8cc2d116e4c51d6a957
  previewUrl: string      // https://customer-{CODE}.cloudflarestream.com/6b9e68b.../watch
}
```

---

## 4. 分享接口

### 4.1 POST /api/apps/:id/deploy
**描述**：开始 Vercel 部署

**请求**：
```typescript
// 无需请求体
```

**响应**：
```typescript
{
  success: true,
  message: "开始部署"
}
```

**错误**：
```typescript
{
  success: false,
  error: "权限不足，只能部署自己的 app"
}
```

### 4.2 GET /api/apps/:id/deploy-status
**描述**：查询部署状态

**响应**：
```typescript
{
  status: "deploying" | "completed" | "failed",
  vercelUrlA: string,  // 模型 A 的部署 URL
  vercelUrlB: string,  // 模型 B 的部署 URL
  progress: number      // 0-100
}
```

### 4.3 POST /api/apps/:id/publish
**描述**：发布到画廊（公开）

**请求**：
```typescript
{
  name: string,         // 应用名称（LLM 自动生成或用户编辑）
  description?: string  // 可选描述
}
```

**响应**：
```typescript
{
  success: true,
  message: "已发布到画廊"
}
```

---

## 5. 画廊接口

### 5.1 GET /api/apps
**描述**：获取应用列表

**查询参数**：
```
category: "hot" | "latest"  // 默认 latest
page: number                  // 默认 1
limit: number                 // 默认 20
```

**响应**：
```typescript
{
  apps: [{
    id: string,
    name: string,
    description?: string,
    prompt: string,
    modelA: string,
    modelB: string,
    previewVideoUrl?: string,  // 有视频优先显示视频，否则显示 Poster
    vercelUrlA?: string,
    vercelUrlB?: string,
    likeCount: number,
    viewCount: number,
    createdAt: string  // ISO 8601
  }],
  total: number,
  page: number,
  limit: number
}
```

### 5.2 GET /api/apps/:id
**描述**：获取应用详情

**响应**：
```typescript
{
  app: {
    id: string,
    userId: string,
    name: string,
    description?: string,
    prompt: string,
    modelA: string,
    modelB: string,
    sandboxIdA: string,
    sandboxIdB: string,
    sandboxHostUrlA: string,
    sandboxHostUrlB: string,
    vercelUrlA?: string,
    vercelUrlB?: string,
    previewVideoUrl?: string,
    isPublic: boolean,
    likeCount: number,
    viewCount: number,
    createdAt: string,
    isOwner: boolean  // 当前用户是否是作者
  }
}
```

### 5.3 POST /api/apps/:id/like
**描述**：点赞应用

**请求**：
```typescript
// 无需请求体
```

**响应**：
```typescript
{
  success: true,
  likeCount: number  // 新的点赞数
}
```

**错误**：
```typescript
{
  success: false,
  error: "已点赞" | "请先登录"
}
```

---

## 6. Sandbox 接口规范

### 6.1 POST /generate
**描述**：开始生成代码

**请求**：
```typescript
{
  prompt: string,
  model: string,      // 模型名称
  apiKey?: string    // 可选，用户自己的 Key
}
```

**响应**：
```typescript
{
  generationId: string  // 用于 SSE 流查询
}
```

**错误**：
```typescript
{
  error: "已有生成中的 Session，请先完成或停止"
}
```

### 6.2 GET /stream/{generationId}
**描述**：SSE 流式返回生成进度

**响应格式**：
```
data: {"status": "generating", "progress": 50, "code": "..."}
data: {"status": "completed", "code": "完整代码"}
```

### 6.3 POST /deploy
**描述**：部署到 Vercel

**环境变量**：
```
VERCEL_TOKEN=xxx  // 启动时传入
```

**响应**：
```typescript
{
  urlA: string,  // 模型 A 的 Vercel URL
  urlB: string   // 模型 B 的 Vercel URL
}
```

---

## 相关文档

- **技术选型**: 详见 [00-技术选型.md](./00-技术选型.md)
- **使用流程**: 详见 [01-使用流程.md](./01-使用流程.md)
- **数据库设计**: 详见 [03-数据库设计.md](./03-数据库设计.md)
