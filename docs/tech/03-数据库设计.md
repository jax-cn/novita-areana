# Novita Arena - 数据库设计

**版本**: 1.2
**最后更新**: 2025-01-17
**状态**: 设计阶段

---

## 目录

1. [数据表设计](#1-数据表设计)
2. [索引设计](#2-索引设计)
3. [数据库约束](#3-数据库约束)
4. [使用说明](#4-使用说明)

---

## 1. 数据表设计

### 1.1 users（用户表）

**用途**：存储用户信息（对接 Novita Auth）

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Novita Auth 关联
  novita_user_id VARCHAR(255) UNIQUE NOT NULL,
  novita_uuid VARCHAR(255) UNIQUE NOT NULL,

  -- 用户信息
  email VARCHAR(255),
  username VARCHAR(100),
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  tier VARCHAR(50),  -- T1, T2, T3, T4...

  -- API Key 管理
  api_key_type VARCHAR(50),  -- novita | claude | other
  api_key VARCHAR(255),

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_users_novita_user_id ON users(novita_user_id);
CREATE INDEX idx_users_email ON users(email);
```

**字段说明**：
- `id`：内部用户 ID（UUID）
- `novita_user_id`：Novita `/user/info` 返回的 `uid`（如 "275"）
- `novita_uuid`：Novita `/user/info` 返回的 `uuid`
- `api_key_type` + `api_key`：用户自己填的 API Key（支持任意类型）

---

### 1.2 apps（应用表）

**用途**：存储生成的应用信息

```sql
CREATE TABLE apps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(255) NOT NULL,  -- users.id 或 IP 地址（匿名用户）

  -- 应用信息
  name VARCHAR(255),
  description TEXT,
  prompt TEXT NOT NULL,

  -- 模型配置
  model_a VARCHAR(100) NOT NULL,
  model_b VARCHAR(100) NOT NULL,

  -- Sandbox IDs（不是 Host URLs）
  sandbox_id_a VARCHAR(255) NOT NULL,
  sandbox_id_b VARCHAR(255) NOT NULL,

  -- Vercel URLs（区分 A 和 B）
  vercel_url_a TEXT,
  vercel_url_b TEXT,
  is_vercel_deploying BOOLEAN DEFAULT FALSE,

  -- 媒体资源
  preview_video_url TEXT,  -- Cloudflare Stream URL

  -- 互动数据
  like_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,

  -- 公开状态
  is_public BOOLEAN DEFAULT FALSE,

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_apps_user_id ON apps(user_id);
CREATE INDEX idx_apps_is_public ON apps(is_public);
CREATE INDEX idx_apps_created_at ON apps(created_at DESC);
CREATE INDEX idx_apps_like_count ON apps(like_count DESC);
```

**字段说明**：
- `user_id`：已登录用户存储 `users.id`，匿名用户存储 IP 地址
- `sandbox_id_a/b`：Sandbox ID（动态获取），不存储 Host URL
- `vercel_url_a/b`：区分两个模型的部署 URL
- `is_vercel_deploying`：部署状态标志
- `preview_video_url`：Cloudflare Stream 预览 URL

---

### 1.3 ip_usage（IP 使用记录）

**用途**：记录匿名用户的免费额度使用

```sql
CREATE TABLE ip_usage (
  ip VARCHAR(45) PRIMARY KEY,  -- IPv4 或 IPv6
  used_at TIMESTAMP DEFAULT NOW(),
  app_count INTEGER DEFAULT 1  -- 可扩展为多次免费机会
);
```

**字段说明**：
- `ip`：用户 IP 地址（支持 IPv6）
- `used_at`：首次使用时间
- `app_count`：已创建的 app 数量（当前固定为 1）

---

### 1.4 likes（点赞表）

**用途**：记录用户点赞（防止重复）

```sql
CREATE TABLE likes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  app_id UUID REFERENCES apps(id) ON DELETE CASCADE,
  user_id VARCHAR(255) NOT NULL,  -- users.id 或 IP 地址

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW(),

  -- 唯一约束
  UNIQUE(app_id, user_id)
);

-- 索引
CREATE INDEX idx_likes_app_id ON likes(app_id);
CREATE INDEX idx_likes_user_id ON likes(user_id);
```

**字段说明**：
- `app_id`：关联的 app
- `user_id`：已登录用户存储 `users.id`，匿名用户存储 IP 地址
- `UNIQUE(app_id, user_id)`：防止同一用户重复点赞

---

## 2. 索引设计

### 2.1 性能优化索引
```sql
-- apps 表
CREATE INDEX idx_apps_user_id_created ON apps(user_id, created_at DESC);  -- 用户历史查询
CREATE INDEX idx_apps_public_created ON apps(is_public, created_at DESC);  -- 画廊列表查询
CREATE INDEX idx_apps_public_likes ON apps(is_public, like_count DESC);  -- 热门查询

-- likes 表
CREATE INDEX idx_likes_created ON likes(created_at DESC);  -- 点赞历史查询
```

### 2.2 全文搜索索引（可选）
```sql
-- apps.prompt 全文搜索
CREATE INDEX idx_apps_prompt_gin ON apps USING gin(to_tsvector('english', prompt));
```

---

## 3. 数据库约束

### 3.1 外键约束
```sql
-- likes.app_id 关联 apps.id
ALTER TABLE likes ADD CONSTRAINT fk_likes_app_id
  FOREIGN KEY (app_id) REFERENCES apps(id) ON DELETE CASCADE;
```

### 3.2 唯一约束
```sql
-- 防止重复点赞
CREATE UNIQUE INDEX idx_likes_unique ON likes(app_id, user_id);

-- Novita 用户信息唯一
ALTER TABLE users ADD CONSTRAINT uk_users_novita_user_id
  UNIQUE (novita_user_id);

ALTER TABLE users ADD CONSTRAINT uk_users_novita_uuid
  UNIQUE (novita_uuid);
```

### 3.3 检查约束（可选）
```sql
-- 用户只能点赞一次（通过唯一约束已实现）
-- 匿名用户 IP 只能创建一次 app（通过 ip_usage 主键已实现）
```

---

## 4. 使用说明

### 4.1 匿名用户逻辑
- `apps.user_id` 存储字符串类型的 IP 地址
- `likes.user_id` 存储字符串类型的 IP 地址
- IP 额度检查：查询 `ip_usage` 表，如果存在则拒绝创建

### 4.2 已登录用户逻辑
- `apps.user_id` 存储 `users.id`（UUID）
- `likes.user_id` 存储 `users.id`（UUID）
- 创建 app 时检查 `users.api_key` 是否存在

### 4.3 Sandbox ID 动态获取
- 不在 `apps` 表存储 Host URL
- 只存储 Sandbox ID（`sandbox_id_a`, `sandbox_id_b`）
- Host URL 通过 Sandbox API 动态获取

### 4.4 Vercel URL 区分
- `vercel_url_a`：模型 A 的部署 URL
- `vercel_url_b`：模型 B 的部署 URL
- 部署完成后更新这两个字段

---

## 5. 数据清理策略

### 5.1 定时清理（可选）
```sql
-- 清理超过 30 天未公开的匿名用户 apps
DELETE FROM apps
WHERE is_public = FALSE
  AND user_id NOT IN (SELECT id FROM users)
  AND created_at < NOW() - INTERVAL '30 days';

-- 清理超过 90 天的点赞记录（可选）
DELETE FROM likes
WHERE created_at < NOW() - INTERVAL '90 days';
```

### 5.2 备份策略
- 使用 Supabase 自动备份
- 定期导出数据库快照到 S3

---

## 相关文档

- **技术选型**: 详见 [00-技术选型.md](./00-技术选型.md)
- **使用流程**: 详见 [01-使用流程.md](./01-使用流程.md)
- **接口设计**: 详见 [02-接口设计.md](./02-接口设计.md)
