# Novita Arena - 数据库设计

**版本**: 2.0
**最后更新**: 2025-01-18
**状态**: 设计阶段

---

## 目录

1. [数据表设计](#1-数据表设计)
2. [索引设计](#2-索引设计)
3. [数据库约束](#3-数据库约束)
4. [使用说明](#4-使用说明)
5. [迁移说明](#5-迁移说明)

---

## 1. 数据表设计

### 1.1 users（用户表）

**用途**：存储用户信息（对接 Novita Auth）

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Novita Auth 关联
  novita_user_id VARCHAR(255) UNIQUE NOT NULL,
  novita_uuid VARCHAR(255) UNIQUE NOT NULL,

  -- 用户信息
  email VARCHAR(255),
  username VARCHAR(100),
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  tier VARCHAR(50),  -- T1, T2, T3, T4...

  -- API Key（仅 Novita）
  novita_api_key VARCHAR(255),

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_users_novita_user_id ON users(novita_user_id);
CREATE INDEX idx_users_email ON users(email);
```

**字段说明**：
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 内部用户 ID |
| novita_user_id | VARCHAR | Novita 返回的 uid（如 "275"） |
| novita_uuid | VARCHAR | Novita 返回的 uuid |
| novita_api_key | VARCHAR | 用户的 Novita API Key（加密存储） |

---

### 1.2 apps（应用表）

**用途**：存储生成的应用信息和 HTML 内容

```sql
CREATE TABLE apps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(255) NOT NULL,  -- users.id 或 IP 地址（匿名用户）

  -- 应用信息
  name VARCHAR(255),
  description TEXT,
  prompt TEXT NOT NULL,

  -- 模型配置
  model_a VARCHAR(100) NOT NULL,
  model_b VARCHAR(100) NOT NULL,

  -- 生成的 HTML 内容（核心字段）
  html_content_a TEXT,  -- 模型 A 生成的完整 HTML
  html_content_b TEXT,  -- 模型 B 生成的完整 HTML

  -- 媒体资源
  preview_video_url TEXT,  -- Cloudflare Stream URL

  -- 互动数据
  like_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,

  -- 公开状态
  is_public BOOLEAN DEFAULT FALSE,

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_apps_user_id ON apps(user_id);
CREATE INDEX idx_apps_is_public ON apps(is_public);
CREATE INDEX idx_apps_created_at ON apps(created_at DESC);
CREATE INDEX idx_apps_like_count ON apps(like_count DESC);
```

**字段说明**：
| 字段 | 类型 | 说明 |
|------|------|------|
| user_id | VARCHAR | 已登录用户存储 users.id，匿名用户存储 IP |
| html_content_a | TEXT | 模型 A 生成的 HTML（最大约 1MB） |
| html_content_b | TEXT | 模型 B 生成的 HTML（最大约 1MB） |
| preview_video_url | TEXT | 录屏视频 URL |
| is_public | BOOLEAN | 是否发布到画廊 |

**移除的字段**（v1.x → v2.0）：
- ~~sandbox_id_a~~ - 不再使用 Sandbox
- ~~sandbox_id_b~~ - 不再使用 Sandbox
- ~~vercel_url_a~~ - 不再部署到 Vercel
- ~~vercel_url_b~~ - 不再部署到 Vercel
- ~~is_vercel_deploying~~ - 不再需要部署状态

---

### 1.3 ip_usage（IP 使用记录）

**用途**：记录匿名用户的免费额度使用

```sql
CREATE TABLE ip_usage (
  ip VARCHAR(45) PRIMARY KEY,  -- IPv4 或 IPv6
  used_count INTEGER DEFAULT 1,
  first_used_at TIMESTAMP DEFAULT NOW(),
  last_used_at TIMESTAMP DEFAULT NOW()
);
```

**字段说明**：
| 字段 | 类型 | 说明 |
|------|------|------|
| ip | VARCHAR(45) | 用户 IP 地址（支持 IPv6） |
| used_count | INTEGER | 已使用次数 |
| first_used_at | TIMESTAMP | 首次使用时间 |
| last_used_at | TIMESTAMP | 最后使用时间 |

---

### 1.4 likes（点赞表）

**用途**：记录用户点赞（防止重复）

```sql
CREATE TABLE likes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  app_id UUID REFERENCES apps(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW(),

  -- 唯一约束（只允许登录用户点赞）
  UNIQUE(app_id, user_id)
);

-- 索引
CREATE INDEX idx_likes_app_id ON likes(app_id);
CREATE INDEX idx_likes_user_id ON likes(user_id);
```

**字段说明**：
| 字段 | 类型 | 说明 |
|------|------|------|
| app_id | UUID | 关联的应用 |
| user_id | UUID | 点赞的用户（必须登录） |

---

## 2. 索引设计

### 2.1 性能优化索引

```sql
-- apps 表
CREATE INDEX idx_apps_user_id_created ON apps(user_id, created_at DESC);  -- 用户历史查询
CREATE INDEX idx_apps_public_created ON apps(is_public, created_at DESC);  -- 画廊列表（最新）
CREATE INDEX idx_apps_public_likes ON apps(is_public, like_count DESC);  -- 画廊列表（热门）

-- likes 表
CREATE INDEX idx_likes_created ON likes(created_at DESC);  -- 点赞历史查询
```

### 2.2 全文搜索索引（可选，暂不实现）

```sql
-- apps.prompt 全文搜索
CREATE INDEX idx_apps_prompt_gin ON apps USING gin(to_tsvector('english', prompt));
```

---

## 3. 数据库约束

### 3.1 外键约束

```sql
-- likes.app_id 关联 apps.id
ALTER TABLE likes ADD CONSTRAINT fk_likes_app_id
  FOREIGN KEY (app_id) REFERENCES apps(id) ON DELETE CASCADE;

-- likes.user_id 关联 users.id
ALTER TABLE likes ADD CONSTRAINT fk_likes_user_id
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
```

### 3.2 唯一约束

```sql
-- 防止重复点赞
CREATE UNIQUE INDEX idx_likes_unique ON likes(app_id, user_id);

-- Novita 用户信息唯一
ALTER TABLE users ADD CONSTRAINT uk_users_novita_user_id UNIQUE (novita_user_id);
ALTER TABLE users ADD CONSTRAINT uk_users_novita_uuid UNIQUE (novita_uuid);
```

### 3.3 检查约束

```sql
-- HTML 内容大小限制（约 1MB）
ALTER TABLE apps ADD CONSTRAINT chk_html_content_a_size
  CHECK (octet_length(html_content_a) <= 1048576);

ALTER TABLE apps ADD CONSTRAINT chk_html_content_b_size
  CHECK (octet_length(html_content_b) <= 1048576);
```

---

## 4. 使用说明

### 4.1 匿名用户逻辑

- `apps.user_id` 存储字符串类型的 IP 地址
- IP 额度检查：查询 `ip_usage` 表
- 默认允许每个 IP 使用 N 次（可配置）
- 匿名用户**不能**点赞

### 4.2 已登录用户逻辑

- `apps.user_id` 存储 `users.id`（UUID）
- 创建 app 时检查 `users.novita_api_key` 是否存在
- 可以点赞（记录到 `likes` 表）

### 4.3 HTML 内容存储

- 直接存储在 PostgreSQL TEXT 字段
- 最大 1MB 大小限制（通过 CHECK 约束）
- 区分模型 A 和模型 B 的内容

### 4.4 点赞计数

- 使用触发器或应用层逻辑维护 `apps.like_count`
- 每次插入/删除 `likes` 记录时更新

```sql
-- 触发器方案（可选）
CREATE OR REPLACE FUNCTION update_like_count()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    UPDATE apps SET like_count = like_count + 1 WHERE id = NEW.app_id;
  ELSIF TG_OP = 'DELETE' THEN
    UPDATE apps SET like_count = like_count - 1 WHERE id = OLD.app_id;
  END IF;
  RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_like_count
AFTER INSERT OR DELETE ON likes
FOR EACH ROW EXECUTE FUNCTION update_like_count();
```

---

## 5. 迁移说明

### 5.1 从 v1.x 迁移到 v2.0

**新增字段**：
```sql
ALTER TABLE apps ADD COLUMN html_content_a TEXT;
ALTER TABLE apps ADD COLUMN html_content_b TEXT;
```

**移除字段**：
```sql
ALTER TABLE apps DROP COLUMN IF EXISTS sandbox_id_a;
ALTER TABLE apps DROP COLUMN IF EXISTS sandbox_id_b;
ALTER TABLE apps DROP COLUMN IF EXISTS vercel_url_a;
ALTER TABLE apps DROP COLUMN IF EXISTS vercel_url_b;
ALTER TABLE apps DROP COLUMN IF EXISTS is_vercel_deploying;
```

**修改 users 表**：
```sql
-- 重命名 api_key 为 novita_api_key
ALTER TABLE users RENAME COLUMN api_key TO novita_api_key;

-- 移除 api_key_type（不再需要）
ALTER TABLE users DROP COLUMN IF EXISTS api_key_type;
```

**修改 ip_usage 表**：
```sql
-- 添加 used_count 字段（支持多次免费）
ALTER TABLE ip_usage ADD COLUMN used_count INTEGER DEFAULT 1;
ALTER TABLE ip_usage RENAME COLUMN used_at TO first_used_at;
ALTER TABLE ip_usage ADD COLUMN last_used_at TIMESTAMP DEFAULT NOW();
```

---

## 相关文档

- **技术选型**: 详见 [00-技术选型.md](./00-技术选型.md)
- **使用流程**: 详见 [01-使用流程.md](./01-使用流程.md)
- **接口设计**: 详见 [02-接口设计.md](./02-接口设计.md)
